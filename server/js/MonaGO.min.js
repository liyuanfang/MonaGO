!function(){Array.prototype.intersection=function(){var a,b=this.length,c=arguments,d=[];for(a=0;a<b;a+=1)c[0].includes(this[a])&&d.push(this[a]);return d},Array.prototype.getGeneString=function(){for(var a="",b=this.length,c=arguments,d=0;d<b;d++)a+=this[d]+c[0];return a.slice(0,a.length-1)},Array.prototype.unique=function(){var b,a={},c=this.length,d=[];for(b=0;b<c;b+=1)a[this[b]]=this[b];for(b in a)d.push(a[b]);return d};var a=function(){function ia(){n.gene_info={},n.go_inf.forEach(function(a,b){var c=b;a.genes.forEach(function(a,b){if(void 0!=n.gene_info[a]){var d=";"+c.toString();n.gene_info[a]=n.gene_info[a]+d}else n.gene_info[a]=c.toString()})})}function ja(){n.dic={};for(var a=n.go_inf.length,b=0;b<a;b++)for(var c=0;c<a;c++)if(b==c)n.dic[b+"-"+c]="";else{var d=n.go_inf[b].genes,e=n.go_inf[c].genes,f=d.intersection(e);n.dic[b+"-"+c]=f.getGeneString("|")}}function la(){var a=Number(n.go_inf[0].pVal);for(i=0;i<b;i++)Number(n.go_inf[i].pVal)<a&&(a=Number(n.go_inf[i].pVal));return a}function ma(a){goids=[];var b=new Queue,c=[a,1];for(goids.push(c),b.enqueue(c);!b.isEmpty();)if(c=b.dequeue(),go=c[0],level=c[1],current=oa(go),void 0!=current)for(var d=current.p,e=0,f=d.length;e<f;e++)void 0!=d[e]&&(a=d[e],c=[a,level+1],goids.push(c),b.enqueue(c));return goids}function na(a,b){a=ra(a),nodes=[],links=[],nodeIndex={},levels=a[a.length-1][1],level_width={};for(var c=0,d=a.length;c<d;c++)go_level=a[c],goid=go_level[0],level=go_level[1],node={},node.name=oa(goid).n,node.id=goid,node.r=10,node.is="node",nodeIndex[goid]=c,void 0==level_width[level]?(level_width[level]=1,node.position=1):(level_width[level]++,node.position=level_width[level]),nodes.push(node);for(var c=0,d=a.length;c<d;c++)if(go_level=a[c],goid=go_level[0],level=go_level[1],parents=oa(goid).p,parents.length>0)for(var e=0,f=parents.length;e<f;e++)parent=parents[e],pgoid=parent,pIndex=nodeIndex[pgoid],pgoid==b&&(nodes[c].is="child",nodes[c].r=30),void 0!=pIndex&&(link={},link.source=pIndex,link.target=c,link.value=5,links.push(link));else nodes[c].fixed=!0,nodes[c].x=P/2,nodes[c].y=50,nodes[c].is="root";return nodes[nodeIndex[b]].fixed=!0,nodes[nodeIndex[b]].x=P/2,nodes[nodeIndex[b]].y=Q-20,nodes[nodeIndex[b]].is="target",{nodes:nodes,links:links}}function oa(a){return goNodes[a]}function ra(a){var b={},c=[];for(i=0;i<a.length;i++)b[a[i][0]]=a[i][1];for(i in b)arr=[i,b[i]],c.push(arr);return c}function sa(b,c){a.nodes(b.nodes).links(b.links);var d=d3.scale.category10(),e=d3.scale.linear().domain([0,d3.max(b.nodes,function(a){return a.r})]).range([5,10]),f=c.selectAll("line.link").data(b.links).enter().append("line").attr("class","link").style("stroke",function(a,b){return d(a.type)}).style("stroke-width",2),g=c.selectAll("circle.node").data(b.nodes).enter().append("circle").attr("class","node").attr("r",function(a){return e(a.r)}).style("fill",function(a,b){return"root"==a.is?"black":"target"==a.is||"child"==a.is?"orange":"lightblue"}).call(a.drag).on("click",function(a,b){a.fixed=!0}),h=c.selectAll("text.node").data(b.nodes).enter().append("text").attr("class","node").text(function(a){return a.name}).call(a.drag);a.on("tick",function(a){f.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),g.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y}),h.attr("x",function(a){return a.x}).attr("y",function(a){return a.y+e(a.r)+10})}),a.start()}function wa(b,c,d,e){a={},a=d3.layout.force().charge(-3e3).linkDistance(50).theta(.2).gravity(1).size([d,e]),struct=ma(b),data=na(struct,b),c.selectAll("line.link").remove(),c.selectAll("circle.node").remove(),c.selectAll("text.node").remove(),sa(data,c)}function xa(){var a=Number(n.go_inf[0].pVal);for(i=0;i<b;i++)Number(n.go_inf[i].pVal)>a&&(a=Number(n.go_inf[i].pVal));return a}function ya(){function a(a,b){return a<b?1:a>b?-1:0}for(q=[],i=0;i<b;i++)q[i]=Number(n.go_inf[i].pVal);return q.sort(a),q}function za(){function c(a,b,c){for(i=0;i<t.length;i++)if(t[i]<=a&&a<=t[i+1])return(10-i)*(c-b)/10+b}var a=15,b=30;n.go_inf.map(function(d){d.size=c(d.pVal,a,b)})}function Aa(a,b){for(i=0;i<t.length-1;i++)if(t[i]<=a&&a<t[i+1])return w[i];if(t[t.length-1]==a)return w[9]}function Ba(a){function d(a){return a.toFixed(4).toString()}var b=[],c=[];for(b.push("p-value"),b.push("<hr></hr>"),i=0;i<t.length-1;i++)from=t[i],to=t[i+1],c.push('<i id="'+z[i]+'" style="background:'+Aa(from,a)+'" ></i> '+d(from)+" - "+d(to));panelLabel=b+c.join("<br>"),$("#pval-label").append(panelLabel)}function Ca(a){function c(a){var b=0;return h.map(function(c,d){c.index==a&&(b=d)}),b}return a<b?array_order.indexOf(parseInt(a)):c(parseInt(a))}function Da(a){var b=[];for(var c in a)b.push(c);return b}function Fa(){function b(a,b,c){var d,e;return e="rotate("+(180*a.angle/Math.PI-90)+")translate("+(a.radius+5)+",0)",d=d3.interpolate(c,e),function(a){return d(a)}}var a=[];h.map(function(b){b.numOfOverlappingGenes>0&&a.push(b)}),_=_.data(h,function(a){return a.index}),_.enter().append("g"),_.exit().remove(),_.transition().duration(500).attrTween("transform",b).attr("class","clusterNodeView"),_.selectAll("circle").remove(),circle=_.append("circle"),circle.attr("r",function(a){if(a.numOfOverlappingGenes>0||void 0==a.numOfOverlappingGenes)return 6}).style("fill",function(a){return"Expanded"==a.status?"rgb(94, 141, 141)":"red"}).on("click",db).append("title").text(function(a,b){return"Click to cluster"}),aa.selectAll("text").remove(),aa=aa.data(h,function(a){return a.index}),aa.enter().append("g"),aa.exit().remove(),aa.transition().duration(500).attrTween("transform",b).attr("class","clusterText"),ga=aa.append("g"),text=ga.attr("transform",function(a){return"rotate("+(90-180*a.angle/Math.PI)+")translate(0,5)"}).append("text"),text.attr("height","auto").attr("text-anchor","middle").text(function(a){if(a.numOfOverlappingGenes>0||void 0==a.numOfOverlappingGenes)return a.numOfOverlappingGenes}).attr("style","text-align:center;padding:2px;margin:2px;fill:white").on("click",db).append("title").text(function(a,b){return"Click to cluster"})}function Ga(a){var c=[],d=[];a.map(function(a){void 0!=a&&0!=a[3]&&c.push(a)}),c.map(function(a){var c=a[0],e=a[1];c<b?(c=Ca(c),firstNode=j[c]):(c=Ca(c),firstNode=h[c]),e<b?(e=Ca(e),secondNode=j[e]):(e=Ca(e),secondNode=h[e]),firstNode.angle-secondNode.angle>Math.PI?(startAngle=secondNode.angle,endAngle=firstNode.angle):(startAngle=firstNode.angle,endAngle=secondNode.angle),firstNode.radius>secondNode.radius?radius=firstNode.radius:radius=secondNode.radius,d.push({index:a[0],radius:radius,startAngle:startAngle,endAngle:endAngle})}),X=X.data(d,function(a){return a.index}),X.enter().append("path"),X.exit().remove(),X.style("fill","green").attr("class","clusterArc").transition().duration(500).attr("d",function(a){var b=d3.svg.arc().innerRadius(a.radius+10).outerRadius(a.radius+11).startAngle(a.startAngle).endAngle(a.endAngle);return b()})}function Ha(a){var c=[],d=[],e=[];a.map(function(a){void 0!=a&&0!=a[3]&&c.push(a)}),c.map(function(a){firstNodeIndex=a[0],secondNodeIndex=a[1],clusterNodeIndex=a[2],firstNodeIndex<b?(firstNodeIndex=Ca(firstNodeIndex),firstNode=j[firstNodeIndex]):(firstNodeIndex=Ca(firstNodeIndex),firstNode=h[firstNodeIndex]),secondNodeIndex<b?(secondNodeIndex=Ca(secondNodeIndex),secondNode=j[secondNodeIndex]):(secondNodeIndex=Ca(secondNodeIndex),secondNode=h[secondNodeIndex]),clusterNodeIndex<b?(clusterNodeIndex=Ca(clusterNodeIndex),clusterNode=j[clusterNodeIndex]):(clusterNodeIndex=Ca(clusterNodeIndex),clusterNode=h[clusterNodeIndex]),firstLineAngle=firstNode.angle,firstLineInnerPosition=firstNode.radius,firstLineOuterPosition=clusterNode.radius,secondLineAngle=secondNode.angle,secondLineInnerPosition=secondNode.radius,secondLineOuterPosition=clusterNode.radius,d.push({index:a[0],LineInnerPosition:firstLineInnerPosition,LineOuterPosition:firstLineOuterPosition,LineAngle:firstLineAngle}),e.push({index:a[1],LineInnerPosition:secondLineInnerPosition,LineOuterPosition:secondLineOuterPosition,LineAngle:secondLineAngle})}),Y=Y.data(d,function(a){return a.index}),Y.enter().append("path"),Y.exit().remove(),Y.style("fill","green").attr("class","clusterLine").transition().duration(500).attr("d",function(a){var c=d3.svg.arc().innerRadius(a.index>b?a.LineInnerPosition+5:a.LineInnerPosition).outerRadius(a.LineOuterPosition+5).startAngle(a.LineAngle).endAngle(a.LineAngle+.002);return c()}),Z=Z.data(e,function(a){return a.index}),Z.enter().append("path"),Z.exit().remove(),Z.style("fill","green").attr("class","clusterLine").transition().duration(500).attr("d",function(a){var c=d3.svg.arc().innerRadius(a.index>b?a.LineInnerPosition+5:a.LineInnerPosition).outerRadius(a.LineOuterPosition+5).startAngle(a.LineAngle).endAngle(a.LineAngle+.002);return c()})}function Ia(a){Ga(a),Ha(a),Fa()}function Ja(a){R.scale()<.5?R.scale(.5):((a?N.transition():N).attr("transform","translate("+R.translate()+") scale("+R.scale()+")"),ga&&(R.scale()<.8&&.8<S<.9&&ga.attr("visibility","hidden"),R.scale()>=.7&&ga.attr("visibility","visible")),S=R.scale())}function Ka(a){function e(a){var f=clusterHierData[a][0],g=clusterHierData[a][1];f<c?b.push({level:a,nodeId:f}):e(f-c),g<c?b.push({level:a,nodeId:g}):e(g-c),d.push(a)}var b=[],d=[];return e(a-c),{leafNodes:b,clusterNodesLevel:d}}function La(a){var b=[];return a.map(function(a){b.push(Ca(a.nodeId))}),b}function Na(a){var b=[];return console.log(a),console.log(n.go_inf),a.map(function(a){n.go_inf[a].genes.map(function(a,c){b.push(a)})}),b.unique()}function Oa(a){var b=0;return a.map(function(a,c){b+=parseFloat(a.pVal)}),b/=a.length}function Pa(a,b){var c=Na(a),d=n.go_inf.splice(a[0],a.length),e=[],f=[];d.map(function(a){e.push(a.GO_id),f.push(a.GO_name)});var g=Oa(d),h={GO_id:e,GO_name:f,count:c.length,pVal:g,genes:c,nodeBeingClicked:b};return n.go_inf.splice(a[0],0,h),d}function Qa(a,b){var c;n.go_inf.map(function(b,d){b.nodeBeingClicked==a&&(c=d)}),n.go_inf.splice(c,1),b.map(function(a,b){n.go_inf.splice(c+b,0,a)})}function Ra(){function c(a,b){var c=0;return a.map(function(a){b.indexOf(a)!=-1&&c++}),c}var a=[],b=[];return n.go_inf.map(function(d,e){b=[],n.go_inf.map(function(a,f){var g=0;if(e!=f)var g=c(d.genes,a.genes);b.push(g)}),a.push(b)}),matrix=a,a}function Sa(a){ba=ba.data(C.groups()),ba.enter().append("svg:path"),ba.exit().remove(),ca=ba.style("fill",function(a){return Aa(Number(n.go_inf[a.index].pVal),v)}).style("stroke",function(a){return Aa(Number(n.go_inf[a.index].pVal),v)}).attr("d",d3.svg.arc().innerRadius(I).outerRadius(J)).attr("id","chordGroups").on("mouseover",Ab),ea=ea.data(C.chords()),ea.enter().append("svg:path"),ea.exit().remove(),fa=ea.attr("class","chord").attr("d",d3.svg.chord().radius(I)).attr("id","chordChords").on("mouseover",Gb),fa.classed("fade",function(a){return 1})}function Ua(a,c,d,e,f,g,i){return a<b?(a=Ca(a),firstNode=j[a]):(a=Ca(a),firstNode=h[a]),c<b?(c=Ca(c),secondNode=j[c]):(c=Ca(c),secondNode=h[c]),angle=(firstNode.angle+secondNode.angle)/2,f==e&&"collapse"==d?radius=i:void 0!=g&&g.map(function(a){return a.nodeId}).indexOf(e)!=-1?g.map(function(a){a.nodeId==e&&(radius=a.radius)}):radius=firstNode.radius>secondNode.radius?firstNode.radius+5:secondNode.radius+5,[angle,radius]}function Va(a,b,c,d,e,f){for(i=0;i<a.length;i++)void 0!=a[i]&&(firstNode=a[i][0],secondNode=a[i][1],index=a[i][2],numOfOverlappingGenes=a[i][3],position=Ua(firstNode,secondNode,c,index,b,e,f),b==index?"collapse"==c?nodeObj={index:index,angle:position[0],radius:position[1],numOfOverlappingGenes:numOfOverlappingGenes,status:"Collapsed"}:nodeObj={index:index,angle:position[0],radius:position[1],numOfOverlappingGenes:numOfOverlappingGenes,status:"Expanded"}:d.indexOf(index.toString())!=-1?nodeObj={index:index,angle:position[0],radius:position[1],numOfOverlappingGenes:numOfOverlappingGenes,status:"Collapsed"}:nodeObj={index:index,angle:position[0],radius:position[1],numOfOverlappingGenes:numOfOverlappingGenes,status:"Expanded"},h.push(nodeObj))}function Wa(a){var b=[],c=[];return array_order.map(function(d,e){a.indexOf(e)==-1?b.push(d):(a.indexOf(e)==a.length-1&&b.push(d),c.push(d))}),d=array_order,array_order=b,c}function Xa(a){var b;array_order.map(function(c,d){a.indexOf(c)!=-1&&(b=d)}),array_order.splice(b,1),a.map(function(a,c){array_order.splice(b+c,0,a)})}function Ya(a,b){var c=d[a[a.length-1]],e=[];return clusterHierData.map(function(a,d){b.indexOf(d)==-1?e.push(a):b.indexOf(d)==b.length-1?e.push([c,c,a[2]]):e.push(void 0)}),e}function Za(a){return a.map(function(a,b){clusterHierData[a[2]-c]=a}),clusterHierData}function $a(a){var b=[];return a.map(function(a,c){b.push(clusterHierData[a])}),b}function _a(a,b,c,d,e){var f;h.map(function(a){a.index==c&&(f=a.radius)}),h=[],j=[],C.groups().forEach(function(a,b){nodeObj={index:a.index,angle:(a.startAngle+a.endAngle)/2,radius:J},j.push(nodeObj)});var g=$a(b);return clusterHierData=Ya(a,b),Va(clusterHierData,c,"collapse",d,e,f),[g,clusterHierData]}function ab(a,b,c,d,e){return h=[],j=[],C.groups().forEach(function(a,b){nodeObj={index:a.index,angle:(a.startAngle+a.endAngle)/2,radius:J},j.push(nodeObj)}),clusterHierData=Za(a,b),Va(clusterHierData,c,"expand",d,e),clusterHierData}function bb(a){var b=Ka(a),c=La(b.leafNodes).unique(),d=b.clusterNodesLevel,e=Pa(c,a),g=Wa(c);matrix=Ra(),C=B.matrix(matrix);var i=_a(c,d,a,Object.keys(f),f.clusterNodesRadius);if(removedHierData=i[0],clusterHierData=i[1],void 0!=f.clusterNodesRadius)var j=f.clusterNodesRadius;else j=[];h.map(function(b){b.index==a&&j.push({nodeId:b.index,radius:b.radius})}),f.clusterNodesRadius=j;var k={go_inf:e,array_order:g,clusterHierData:removedHierData,clusterNodesLevel:d};return f[a]=k,clusterHierData}function cb(a){nodeBeingMemorized=f[a],Qa(a,nodeBeingMemorized.go_inf),Xa(nodeBeingMemorized.array_order);var b=Da(f),c=nodeBeingMemorized.clusterNodesLevel,d=f.clusterNodesRadius,e=[];d.map(function(b,c){b.nodeId!=a&&e.push(b)}),d=e,f.clusterNodesRadius=d,matrix=Ra(),C=B.matrix(matrix);var g=ab(nodeBeingMemorized.clusterHierData,c,a,b,d);return delete f[a],g}function db(a,b){var c=a.index;"Expanded"==a.status?clusterHierData=bb(c):clusterHierData=cb(c),eb(clusterHierData)}function eb(a){fb(),1==g&&Ia(a)}function fb(){ja(),ia(),Sa(matrix)}function ib(a){var b=-1;return n.clusterHierDataStatic.map(function(c,d){c[1]>=a&&(b=d)}),b}function jb(a){console.log(a),console.log(T);var c=[];if(a>=T)for(var d=a;d>=0;d--){if(void 0!=clusterHierData[d]&&c.indexOf(d)==-1&&void 0==f[clusterHierData[d][2]]){var e=Ka(clusterHierData[d][2]).clusterNodesLevel;e.map(function(a){return c.push(a)}),c=c.unique(),U.push(clusterHierData[e[e.length-1]][2])}U=U.unique()}else{console.log("expand");var g=a+b,i=[];console.log(U),U.reverse().map(function(a,b){if(a>=g){i.push(b);var c=kb(a);clusterHierData=cb(c.index),console.log(clusterHierData)}}),U.splice(i[0],i.length);for(var d=a;d>=0;d--)if(void 0!=clusterHierData[d]&&c.indexOf(d)==-1){var e=Ka(clusterHierData[d][2]).clusterNodesLevel;e.map(function(a){return c.push(a)}),c=c.unique(),U.push(clusterHierData[e[e.length-1]][2])}U=U.unique()}0!=U.length&&U.map(function(a,b){h.map(function(b){a==b.index&&void 0==f[a]&&(clusterHierData=bb(a),console.log(clusterHierData))})}),T=a,console.log(clusterHierData),eb(clusterHierData)}function kb(a){var b;return h.map(function(c){c.index==a&&(b=c)}),b}function lb(a){if("string"==typeof a){$("#content").append('<div id="go_chart"></div>');var b=d3.select("#go_chart").append("svg").attr("width",P).attr("height",Q);b.append("rect").style("fill","white").style("stroke","gray").attr("width",P).attr("height",Q).attr("x",0).attr("y",0),wa(a,b,P,Q)}}function mb(a){return a.replace(":","_")}function ob(a){var b="";return b+="<div class='gene_content'>",a.genes.forEach(function(a,c){var d="<p>"+(c+1)+".<n class='gene_name'>"+a+"</n> </p>";b+=d}),b+="</div>"}function qb(a){var b={};return n.go_inf_ori.forEach(function(c,d){c.GO_name==a&&(b=c)}),b}function rb(a){var b="",c=qb(a);b+="<div class='go_detail_content'>",b+="<p> <a class='prop-field'> GO_id: </a>"+c.GO_id+"</p>",b+=" <p> <a class='prop-field'>Num of genes: </a>"+c.count+"</p><p> <a class='prop-field'>P-value: </a>"+c.pVal+"</p>";var d=ob(c),e="<a class='prop-field gene_dropmenu'>Genes:</a><b id='caret_gene' class='caret rotate180'></b>"+d+"</p>";return b+=e,b+="<div id='"+mb(c.GO_id)+"'></div>",b+="</div>"}function sb(a){return"string"==typeof a?1:a.length}function tb(a){var b="<div class='go_List'>";return K=[],a.forEach(function(a,c){var d=rb(a);K.push(a);var e="<li>"+(c+1)+".<n class='Go_name go_detail_dropmenu'>"+a+"</n> <b id='caret_GO_details' class='caret'></b>"+d+"</li>";b+=e}),b+="</div>"}function ub(a){function c(a){"string"==typeof a?b.push(a):a.forEach(function(a){c(a)})}var b=[];return c(a),b}function vb(a){var b="",c=sb(ub(n.go_inf[a].GO_id)),d="<p> <a class='prop-field'> GO_id: </a>"+ub(n.go_inf[a].GO_id).join(", ")+"</p>";1==c?(d+="<p> <a class='prop-field'>GO_Name: </a>"+ub(n.go_inf[a].GO_name)+"</p>",d+=" <p> <a class='prop-field'>Num of genes: </a>"+n.go_inf[a].count+"</p><p> <a class='prop-field'>P-value: </a>"+n.go_inf[a].pVal+"</p>"):(d+="<a class='prop-field go_dropmenu'> GO_name: <b id='caret_GO' class='caret rotate180'></b></a>"+tb(ub(n.go_inf[a].GO_name))+"<p>",d+=" <p> <a class='prop-field'>Num of genes: </a>"+n.go_inf[a].count+"</p><p> <a class='prop-field'>P-value(Average): </a>"+n.go_inf[a].pVal+"</p>");var e=ob(n.go_inf[a]),f="<a class='prop-field gene_dropmenu'>Genes:</a><b id='caret_gene' class='caret rotate180'></b>"+e+"</p>",g=1==c?"<p><a class='prop-field'>GO Hierarchy:</a></p> <div id='go_chart'></div> ":"";return b+=d+f+g}function wb(a){return void 0!=d3.select(a).node().attr("status")&&"true"==d3.select(a).node().attr("status")}function xb(a,b){1==b?d3.select(a).node().attr("status","false"):d3.select(a).node().attr("status","true")}function yb(){var b=!0;$(".gene_dropmenu").click(function(a){var b=wb($(this));$(this).next().css("transform",function(){return b?"rotate(180deg)":"rotate(0deg)"}),xb($(this),b),$geneList=$(this).next().next(),$geneList.slideToggle(500)}),$(".gene_name").click(function(){$("#filter").val($(this).html()),$("#filter").focus(),Rb()}),$(".go_id").click(function(){$("#filter").val($(this).html()),Rb()}),$(".go_dropmenu").click(function(a){$("#caret_GO").css("transform",function(){return b?"rotate(0deg)":"rotate(180deg)"}),b=!b,$goList=$(this).next(),$goList.slideToggle(500)}),$(".go_detail_dropmenu").click(function(a){var b=wb($(this));$(this).next().css("transform",function(){return b?"rotate(0deg)":"rotate(180deg)"}),xb($(this),b),$goList=$(this).next().next(),$goList.slideToggle(500)})}function zb(){K.forEach(function(a,b){goDetail=qb(a);var c=mb(goDetail.GO_id),d=Q-20,e=P-50,f=d3.select("#"+c).append("svg").attr("width",e).attr("height",d);f.append("rect").style("fill","white").style("stroke","gray").attr("width",e).attr("height",d).attr("x",0).attr("y",0),wa(goDetail.GO_id,f,e,d)})}function Ab(a,b){$("#content").empty(),fa.classed("fade",function(a){return a.source.index!=b&&a.target.index!=b});var c=vb(b);$("#content").append(c),yb(),lb(n.go_inf[b].GO_id),zb(),Cb(a.index)}function Cb(a){var b=Db(n.go_inf[a].pVal);Eb(b)}function Db(a){for(i=0;i<t.length-1;i++)if(t[i]<=a&&a<t[i+1])return z[i];if(t[t.length-1]==a)return z[9]}function Eb(a){$("#"+A).css("border","0"),$("#"+a).css("border","solid 3px red"),A=a}function Fb(a,b){var c="<div class='gene_content'>";return n.dic[a].split("|").forEach(function(a,b){var d="<li><a class='gene_name'>"+(b+1)+"."+a+"</a> </li>";c+=d}),c+="</div>",templ="<p>Overlapping genes between <a class='go_id'>"+n.go_inf[b.source.index].GO_id+"</a> and <a class='go_id'>"+n.go_inf[b.source.subindex].GO_id+"</a>:\n</p>"+c,templ}function Gb(a,b){$("#content").empty();var c=a.source.index+"-"+a.source.subindex,d=Fb(c,a);$("#content").append(d),yb()}function Hb(a){for(;0!=a.length;){var b=a.pop();$content=$("#content").on("click","#GO_button_"+b,function(a){var b=a.toElement.id.split("_")[2];fa.classed("fade",function(a){return a.source.index!=b&&a.target.index!=b})})}$(".dropbtn").click(function(){$header=$(this),$content=$header.next(),$content.slideToggle(500)})}function Ib(a){$(".dropbtn").mouseover(function(a){var b=Kb(a.target.id);ca.classed("highlight",function(a){return a.index==b}),Cb(b)}),$(".dropbtn").mouseleave(function(a){var b=Kb(a.target.id);ca.classed("highlight",!1,function(a){return a.index==b}),Jb(b)})}function Jb(a){var b=Db(n.go_inf[a].pVal);$("#"+b).css("border","0")}function Kb(a){var b=a.split("_");return b[b.length-1]}function Lb(a){var b="<div class='gene_content'>";return n.go_inf[a].genes.forEach(function(a,c){var d="<li>"+(c+1)+".<n class='gene_name'>"+a+"</n></li>";b+=d}),b+="</div>"}function Mb(a){var b="",c=0,d="";for(i=0;i<a.length;i++){var c=a[i];d=n.go_inf[c].GO_id+" "+n.go_inf[c].GO_name;var e=sb(n.go_inf[c].GO_id),f='<button class="dropbtn"id=GO_button_'+c+">"+d+"</button>";f+="<div class=\"Go_content\"><p><a class='prop-field'>"+(1==e?" P-value:</a> ":" P-value(Average):</a>")+n.go_inf[c].pVal+" <p><a class='prop-field'> Num of genes: </a>"+n.go_inf[c].count+"<p><a class='prop-field'>Genes: </a>"+Lb(c)+"</div>",b+=f}return b}function Nb(a){for(i in n.go_inf)if(n.go_inf[i].GO_id==a)return i}function Ob(a){if(""==a)return!1;for(arr=a.split(""),i=0;i<arr.length;i++)if(arr[i]<"0"||arr[i]>"9")return!1;return!0}function Pb(a){function b(a,b){return pa=Number(n.go_inf[a].pVal),pb=Number(n.go_inf[b].pVal),pa>pb?1:pa<pb?-1:0}a.sort(b)}function Qb(){ca.transition().duration(500).attr("d",d3.svg.arc().innerRadius(I).outerRadius(J)),fa.transition().duration(500).attr("d",d3.svg.chord().radius(I)),da.transition().duration(500).attr("x",8)}function Rb(){function a(a){if(Ob(a)||"GO"==a.split(":")[0].toUpperCase())return!0;for(var b=0;b<n.go_inf.length;b++)if(n.go_inf[b].GO_name==a.toLowerCase())return!0;return!1}$("#content").empty();var b=$("#filter").val();if(a(b)){Qb();var c;if(Ob(b))b="GO:"+b,c=Nb(b.toUpperCase());else if("GO"==b.split(":")[0].toUpperCase())c=Nb(b.toUpperCase());else for(var d=0;d<n.go_inf.length;d++)n.go_inf[d].GO_name==b.toLowerCase()&&(c=d);if(void 0!=c){genes=Lb(c);var e=vb(c);$("#content").append(e),yb(),lb(n.go_inf[c].GO_id),fa.classed("fade",function(a){return a.source.index!=c&&a.target.index!=c}),ca.transition().attr("d",d3.svg.arc().innerRadius(function(a){return a.index!=c?I:I+10}).outerRadius(function(a){return a.index!=c?J:J+10})),da.transition().attr("x",function(a){return a.index==c?(a.startAngle+a.endAngle)/2<3.1415?20:-10:8}),m=[],m.push(parseInt(c)),Yb(),fa.transition().attr("d",d3.svg.chord().radius(function(a){return a.index!=c?I:I+10}))}}else{var f=n.gene_info[b];if(void 0!=f){var g=f.split(";"),h=[],i=[];for(c=0;c<g.length;c++){var j=parseInt(g[c]);i.push(j),h.push(j)}h.length>1&&Pb(h),$("#content").append(Mb(h)),$(".dropbtn").css("width",D-50),$(".gene_name").click(function(){$("#filter").val($(this).html()),Rb()}),Hb(i),Ib(i),m=[];for(c in g){var j=parseInt(g[c]);m.push(j)}ca.transition().attr("d",d3.svg.arc().innerRadius(function(a){return m.indexOf(a.index)==-1?I:I+5}).outerRadius(function(a,b){return m.indexOf(a.index)==-1?J:J+5})),da.transition().attr("x",function(a){return m.indexOf(a.index)!=-1?(a.startAngle+a.endAngle)/2<3.1415?20:-10:8}),Yb(),fa.transition().attr("d",d3.svg.chord().radius(function(a){return m.indexOf(a.index)==-1?I:I+5}))}else Qb(),Zb(),m=[]}}function Sb(){X.style("fill","green").attr("class","clusterArc").transition().duration(300).attr("d",function(a){var b=d3.svg.arc().innerRadius(a.radius+15).outerRadius(a.radius+16).startAngle(a.startAngle).endAngle(a.endAngle);return b()})}function Tb(){X.style("fill","green").attr("class","clusterArc").transition().duration(300).attr("d",function(a){var b=d3.svg.arc().innerRadius(a.radius+10).outerRadius(a.radius+11).startAngle(a.startAngle).endAngle(a.endAngle);return b()})}function Ub(){Y.style("fill","green").attr("class","clusterLine").transition().duration(300).attr("d",function(a){var c=d3.svg.arc().innerRadius(a.index>b?a.LineInnerPosition+10:a.LineInnerPosition).outerRadius(a.LineOuterPosition+10).startAngle(a.LineAngle).endAngle(a.LineAngle+.002);return c()}),Z.style("fill","green").attr("class","clusterLine").transition().duration(300).attr("d",function(a){var c=d3.svg.arc().innerRadius(a.index>b?a.LineInnerPosition+10:a.LineInnerPosition).outerRadius(a.LineOuterPosition+10).startAngle(a.LineAngle).endAngle(a.LineAngle+.002);return c()})}function Vb(){Y.style("fill","green").attr("class","clusterLine").transition().duration(300).attr("d",function(a){var c=d3.svg.arc().innerRadius(a.index>b?a.LineInnerPosition+5:a.LineInnerPosition).outerRadius(a.LineOuterPosition+5).startAngle(a.LineAngle).endAngle(a.LineAngle+.002);return c()}),Z.style("fill","green").attr("class","clusterLine").transition().duration(300).attr("d",function(a){var c=d3.svg.arc().innerRadius(a.index>b?a.LineInnerPosition+5:a.LineInnerPosition).outerRadius(a.LineOuterPosition+5).startAngle(a.LineAngle).endAngle(a.LineAngle+.002);return c()})}function Wb(){function a(a,b,c){var d,e;return e="rotate("+(180*a.angle/Math.PI-90)+")translate("+(a.radius+10)+",0)",d=d3.interpolate(c,e),function(a){return d(a)}}_.transition().duration(300).attrTween("transform",a).attr("class","clusterNodeView"),aa.transition().duration(300).attrTween("transform",a).attr("class","clusterText")}function Xb(){function a(a,b,c){var d,e;return e="rotate("+(180*a.angle/Math.PI-90)+")translate("+(a.radius+5)+",0)",d=d3.interpolate(c,e),function(a){return d(a)}}_.transition().duration(300).attrTween("transform",a).attr("class","clusterNodeView"),aa.transition().duration(300).attrTween("transform",a).attr("class","clusterText")}function Yb(){Sb(),Ub(),Wb()}function Zb(){Tb(),Vb(),Xb()}function $b(){g=0,X.style("display","none"),Y.style("display","none"),Z.style("display","none"),_.style("display","none"),aa.style("display","none"),da.style("display",""),_b()}function _b(){da.remove(),da=N.append("svg:g").selectAll("g").data(C.groups).enter().append("svg:g").attr("transform",function(a){return"rotate("+((a.startAngle+a.endAngle)/2*180/Math.PI-90)+")translate("+J+",0)"}).append("svg:text").attr("x",function(a){return m.indexOf(a.index)!=-1?(a.startAngle+a.endAngle)/2<3.1415?20:-10:8}).attr("dy",".45em").attr("text-anchor",function(a){return(a.startAngle+a.endAngle)/2>Math.PI?"end":null}).attr("transform",function(a){return(a.startAngle+a.endAngle)/2>Math.PI?"rotate(180)translate(-16)":null}).text(function(a){return"string"==typeof n.go_inf[a.index].GO_id?n.go_inf[a.index].GO_name:ac(n.go_inf[a.index].GO_name)+"+"})}function ac(a){var b=0,c=0;return a.map(function(a,d){c<O[a]&&(c=O[a],b=d)}),a[b]}function bc(){cc(),Yb()}function cc(){Ia(clusterHierData)}function dc(){g=1,X.style("display",""),Y.style("display",""),Z.style("display",""),_.style("display",""),aa.style("display",""),da.style("display","none"),0!=m.length?bc():Ia(clusterHierData),ga&&(R.scale()<.7?ga.attr("visibility","hidden"):ga.attr("visibility","visible"))}function ec(){$("#arrow_detailedPanel").css("transform",function(){return V?"rotate(0deg)":"rotate(180deg)"});var a=D-50;$("#details").css("margin-right",function(){return V?"-"+a+"px":"0"}),V=!V,gc(V),hc(V)}function fc(){$("#arrow_controlPanel").css("transform",function(){return W?"rotate(180deg)":"rotate(0deg)"});var a=E-20;$("#control-panel").css("margin-left",function(){return W?"-"+a+"px":"0"}),W=!W}function gc(a){a?(d3.select(".main_vis").attr("width",G),N.transition().attr("transform","translate("+G/2+","+H/2+") scale("+R.scale()+")")):(d3.select(".main_vis").attr("width",G+D),N.transition().attr("transform","translate("+(G+D)/2+","+H/2+") scale("+R.scale()+")"))}function hc(a){a?d3.select(".pval-label").transition().duration(300).style("margin-left",-D-160):d3.select(".pval-label").transition().duration(300).style("margin-left",-210)}function ic(){var a='&nbsp<label>Cluster GO term according to the minimum number of common gene(s)</label>           <div id="slider" class="sliderBar"></div>          <input type="text" id="input_slider"/>            <table class="RadioBox">            <tbody><tr><td>                  <input id="labelRadioBox" class="radioButton" type="radio" name="radioBox" value="0" checked>                </td><td><label style="padding-left:10px" for="labelRadioBox">Show GO term name</label>                </td></tr><tr><td></td></tr><tr><td>                  <input id="hierClusterRadioBox"  class="radioButton" type="radio" name="radioBox" value="1" >                </td><td>                   <label style="width:300px;padding-left:10px" for="hierClusterRadioBox">Show hierarchical tree and click on the node to manually cluster the GO term</label>                </td></tr></tbody></table>';a+='<button id="editor_save" class="btn" z-index:100">Save image</button>',a+='<button id="arrow_controlPanel" class="arrowBar arrow"></button>',$("#control-panel").append(a);var b=document.getElementById("slider"),c=document.getElementById("input_slider");jc(b,c,l,k)}function jc(a,b,c,d){noUiSlider.create(a,{start:[d+1],step:1,margin:0,direction:"rtl",orientation:"horizontal",range:{min:c,max:d+1}}),a.noUiSlider.on("update",function(a,c){b.value=a[c]}),a.noUiSlider.on("change",function(a,b){var c=ib(a.toString());jb(c),0==g&&_b()}),b.addEventListener("change",function(){a.noUiSlider.set(this.value);var b=ib(this.value);jb(b),0==g&&_b()})}function kc(){$("#filter").keydown(function(a){13==a.which&&(Rb(),$("#searchBox").remove())}),$("#filter_button").click(function(){Rb(),$("#searchBox").remove()}),$("#arrow_detailedPanel").click(function(){ec()}),$("#arrow_controlPanel").click(function(){fc()}),$(".radioButton").change(function(){switch(this.value){case"0":$b();break;case"1":dc()}}),$("#editor_save").click(function(){d3.select("canvas").attr("width",G).attr("height",H);var a=d3.select(".main_vis").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node().parentNode.innerHTML,b="data:image/svg+xml;base64,"+btoa(a),c=document.querySelector("canvas"),d=c.getContext("2d"),e=new Image;e.src=b,e.onload=function(){console.log(c.width),console.log(c.height),d.clearRect(0,0,G,H),d.drawImage(e,0,0);var a=c.toDataURL("image/png");console.log(a),oc("/getPic",{filename:"chart",png:a},null)}})}function lc(a,b){var c;a||(a={});for(c in b)a[c]=b[c];return a}function mc(a,b){lc(a.style,b)}function nc(a,b,c,d,e){var f=window.document.createElement(a),g=mc;return b&&lc(f,b),e&&g(f,{padding:0,border:"none",margin:0}),c&&g(f,c),d&&d.appendChild(f),f}function oc(a,b,c){var d,e;e=nc("form",{method:"post",action:a,enctype:"multipart/form-data"},{display:"none"},window.document.body);for(d in b)nc("input",{type:"hidden",name:d,value:b[d]},null,e);e.submit(),pc(e)}function pc(a){a.remove()}function qc(){main_div=d3.select("#chart").append("div"),$("#details").css("width",D),$("#pval-label").css("margin-left",-D-160),$("#control-panel").css("width",E),$("#control-panel").css("height",F),L=main_div.append("svg:svg").attr("class","main_vis").attr("width",G).attr("height",H).call(R.on("zoom",Ja)),N=L.append("svg:g").attr("id","circle").attr("transform","translate("+G/2+","+H/2+")"),N.append("circle").attr("r",I).style("opacity","0"),X=N.append("svg:g").selectAll("g").data(clusterHierData).enter().append("path"),Y=N.append("svg:g").selectAll("g").data(clusterHierData).enter().append("path"),Z=N.append("svg:g").selectAll("g").data(clusterHierData).enter().append("path"),_=N.append("svg:g").selectAll("g").data(h).enter().append("svg:g").attr("id","clusterNode"),aa=N.append("svg:g").selectAll("g").data(h).enter().append("svg:g"),ba=N.append("svg:g").selectAll("path").data(C.groups).enter().append("svg:path"),ca=ba.style("fill",function(a){return Aa(Number(n.go_inf[a.index].pVal),v)}).style("stroke",function(a){return Aa(Number(n.go_inf[a.index].pVal),v)}).attr("d",d3.svg.arc().innerRadius(I).outerRadius(J)).attr("id","chordGroups").on("mouseover",Ab),da=N.append("svg:g").selectAll("g").data(C.groups).enter().append("svg:g"),
n.go_inf.map(function(a){void 0==O[a.GO_name]&&(O[a.GO_name]=a.size)}),ea=N.append("svg:g").selectAll("path").data(C.chords).enter().append("svg:path"),fa=ea.attr("class","chord").attr("d",d3.svg.chord().radius(I)).attr("id","chordChords").on("mouseover",Gb),ic()}function rc(a){var b=[];return a.forEach(function(a,c){b.push(a)}),b}function sc(){for(o=xa(),p=la(),q=ya(),s=(o-p)/10,i=0;i<11;i++)t.push(p+s*i)}function tc(){B=d3.layout.chord().padding(.03).sortSubgroups(d3.descending),C=B.matrix(matrix),C.groups().forEach(function(a,b){nodeObj={index:a.index,angle:(a.startAngle+a.endAngle)/2,radius:J},j.push(nodeObj)})}var a,b=size,c=size,d=[],f={},g=0,h=[],j=[],k=clusterHierData[0][3],l=clusterHierData[clusterHierData.length-1][3],m=[];this.gene_info={},this.dic={},this.go_inf=[],this.clusterHierData=[],this.clusterHierDataStatic=[];var o,p,s,B,C,L,N,X,Y,Z,_,aa,ba,ca,da,ea,fa,ga,n=this,q=[],t=[],v=d3.scale.ordinal().domain(d3.range(12).reverse()).rangeRoundPoints([1,255]),w=["#1249C9","#0F399B","#0A2B76","#0F2147","#2C3645","#82733D","#E1C03B","#E6AE29","#F2AB1C","#FFAB00"].reverse(),z=["p-1","p-2","p-3","p-4","p-5","p-6","p-7","p-8","p-9","p-10"],A="p-1",D=.25*$(window).width(),E=520,F=160,G=$(window).width()-D,H=$(window).height(),I=.2*Math.min(G,H),J=1.1*I,K=[],O={},P=D-70,Q=600,a=d3.layout.force().charge(-3e3).linkDistance(50).theta(.2).gravity(1).size([P,Q]),R=d3.behavior.zoom().translate([G/2,H/2]),S=1,T=0,U=[],V=!0,W=!0,ha=angular.module("MonaGO");ha.directive("clearBtn",["$parse",function(a){return{link:function(a,b,c,d){b.wrap("<div style='position: relative'></div>");var e='<i class="searchclear ng-hide fa fa-close"></i>',f=angular.element(e);f.css("top",15),b.after(f),f.on("click",function(){m=[],a.searchText="",$("#filter").val(""),$("#filter").focus(),Rb(),$("#searchBox")&&$("#searchBox").remove(),f.addClass("ng-hide"),a.$apply()}),b.bind("focus keyup change paste propertychange",function(a){b.val()&&b.val().length>0?f.removeClass("ng-hide"):f.addClass("ng-hide")})}}}]);this.init=function(a,b,c){n.go_inf=b,n.go_inf_ori=rc(b),n.clusterHierData=c,c.map(function(a){n.clusterHierDataStatic.push([a[2],a[3]])}),n.go_inf.forEach(function(a,b){n.go_inf[b].genes=a.genes.split("|")}),sc(),tc(),ia(),ja(),Ba(v),Va(c,[],"",[]),qc(),za(),$b(),kc()}};(new a).init(size,go_inf,clusterHierData)}();